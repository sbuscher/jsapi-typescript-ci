import { $ as e, a0 as d, a1 as n, a2 as y, t, co as c, h as e$1, dF as un, aq as v, r, R as l, S as h, a9 as f, Q as r$1, s, f as s$1, g as i, a4 as c$2, B as e$2, aE as z, aU as r$2, aV as i$1, M as M$1, aW as t$1, E as f$2, F as h$1, ao as R$1, di as mt, ci as j, cB as a$3, cw as p$1, cx as r$4, dG as s$2, p as g, cu as M$2, dH as r$5, ap as u$1 } from '../index.js';
import { p } from './normalizeUtilsSync.5fa393cb.js';
import { a as a$1 } from './utils.8c9e5b3d.js';
import { c as c$1, f as f$1 } from './VertexArrayObject.cb91c839.js';
import { P, G, L, D, F } from './enums.f11416db.js';
import { n as n$1, u } from './Texture.504bc158.js';
import { r as r$3 } from './vec3f32.d9d17da6.js';
import { b as a$2, W } from './WGLContainer.dfc8c076.js';
import { I } from './Utils.83ec6664.js';
import { f as f$3, u as u$2 } from './LayerView.c04c5e87.js';
import './MaterialKey.65ea99d2.js';
import './enums.480c78cc.js';
import './pixelUtils.db461856.js';
import './VertexElementDescriptor.e016eb10.js';
import './ProgramTemplate.e80a0047.js';
import './StyleDefinition.8c6ccefd.js';
import './config.f27af595.js';
import './GeometryUtils.3261b92c.js';
import './earcut.d6b861a1.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let a=class extends y{constructor(o){super(o);}get bounds(){const o=this.coords;return t(o)?null:c(o.extent)}get coords(){const o=e$1(this.element.georeference)?.coords;return un(o,this.spatialReference).geometry}get normalizedCoords(){return v.fromJSON(p(this.coords))}get normalizedBounds(){return r(this.normalizedCoords)?c(this.normalizedCoords.extent):null}};e([d()],a.prototype,"spatialReference",void 0),e([d()],a.prototype,"element",void 0),e([d()],a.prototype,"bounds",null),e([d()],a.prototype,"coords",null),e([d()],a.prototype,"normalizedCoords",null),e([d()],a.prototype,"normalizedBounds",null),a=e([n("esri.layers.support.media.MediaElementView")],a);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class _ extends a$1{constructor(s$2){super(),this.elementView=s$2,this.isWrapAround=!1,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(l((()=>this.elementView.element.opacity),(e=>this.opacity=e),h),l((()=>[this.elementView.coords]),(()=>{this.requestRender();}),h),f((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&r(e.content)&&this._handles.push(r$1(e.content,"play",(()=>this.requestRender())));}),h)),s$2.element.load().catch((t=>{s.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new s$1("element-load-error","Element cannot be displayed",{element:s$2,error:t}));}));}destroy(){this._handles.forEach((e=>e.remove())),this.texture?.dispose(),this.texture=null;}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,r$1=this.elementView.element.content;if(r(r$1)){const e=r$1 instanceof HTMLImageElement,i$1=r$1 instanceof HTMLVideoElement,o=e?r$1.naturalWidth:i$1?r$1.videoWidth:r$1.width,n=e?r$1.naturalHeight:i$1?r$1.videoHeight:r$1.height;this.texture?i$1&&!r$1.paused&&(this.texture.setData(r$1),this.requestRender(),(n$1(t.gl)||i(o)&&i(n))&&this.texture.generateMipmap()):(this.texture=new u(t,{pixelFormat:P.RGBA,dataType:G.UNSIGNED_BYTE,samplingMode:L.LINEAR,wrapMode:D.CLAMP_TO_EDGE,width:o,height:n},r$1),(n$1(t.gl)||i(o)&&i(n))&&this.texture.generateMipmap(),i$1&&!r$1.paused&&this.requestRender());}super.beforeRender(e);}_createTransforms(){return null}updateDrawCoords(e,t$1){const r=this.elementView.coords;if(t(r))return;const[s,i,n,a]=r.rings[0],h=this._vertices,{x:m,y:l}=e,d=0!==t$1;d?h.set([i[0]-m,i[1]-l,s[0]-m,s[1]-l,n[0]-m,n[1]-l,a[0]-m,a[1]-l,a[0]-m,a[1]-l,i[0]+t$1-m,i[1]-l,i[0]+t$1-m,i[1]-l,s[0]+t$1-m,s[1]-l,n[0]+t$1-m,n[1]-l,a[0]+t$1-m,a[1]-l]):h.set([i[0]-m,i[1]-l,s[0]-m,s[1]-l,n[0]-m,n[1]-l,a[0]-m,a[1]-l]),this.isWrapAround=d;}getVAO(e,t$1,r){if(t(this.elementView.coords))return null;const s=this._vertices;if(this._vao)this._geometryVbo.setData(s);else {this._geometryVbo=c$1.createVertex(e,F.DYNAMIC_DRAW,s);const i=c$1.createVertex(e,F.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new f$1(e,r,t$1,{geometry:this._geometryVbo,tex:i});}return this._vao}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
class M extends a$2{constructor(){super(...arguments),this._localOrigin=c$2(0,0),this._viewStateId=-1,this._dvsMat3=e$2(),this.requiresDedicatedFBO=!1;}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const e of this.children)e.beforeRender(t);}prepareRenderPasses(t){const e=t.registerRenderPass({name:"overlay",brushes:[W.overlay],target:()=>this.children,drawPhase:I.MAP});return [...super.prepareRenderPasses(t),e]}_updateMatrices(t){const{state:e}=t,{id:n,size:l,pixelRatio:m,resolution:h,rotation:f,viewpoint:u,displayMat3:M}=e;if(this._viewStateId===n)return;const v=Math.PI/180*f,_=m*l[0],w=m*l[1],{x:y,y:j}=u.targetGeometry,g=z(y,e.spatialReference);this._localOrigin.x=g,this._localOrigin.y=j;const b=h*_,R=h*w,O=r$2(this._dvsMat3);i$1(O,O,M),M$1(O,O,t$1(_/2,w/2)),f$2(O,O,r$3(_/b,-w/R,1)),h$1(O,O,-v),this._viewStateId=n;}_updateOverlays(e,s){const{state:r}=e,{rotation:o,spatialReference:a,worldScreenWidth:i,size:n,viewpoint:c}=r,p=this._localOrigin;let d=0;if(a.isWrappable){const e=n[0],h=n[1],f=180/Math.PI*o,u=Math.abs(Math.cos(f)),M=Math.abs(Math.sin(f)),v=Math.round(e*u+h*M),[_,w]=R$1(a).valid,y=mt(a),{x:j,y:g}=c.targetGeometry,b=[j,g],R=[0,0];r.toScreen(R,b);const O=[0,0];let P;P=v>i?.5*i:.5*v;const x=Math.floor((j+.5*y)/y),C=_+x*y,D=w+x*y,I=[R[0]+P,0];r.toMap(O,I),O[0]>D&&(d=y),I[0]=R[0]-P,r.toMap(O,I),O[0]<C&&(d=-y);for(const r of s){const e=r.elementView.bounds;if(t(e))continue;const[s,,o]=e;s<_&&o>_?r.updateDrawCoords(p,y):o>w&&s<w?r.updateDrawCoords(p,-y):r.updateDrawCoords(p,d);}}else for(const t of s)t.updateDrawCoords(p,d);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
let w=class extends(f$3(u$2)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new j;}attach(){this.handles.add(a$3((()=>this.layer.source),"refresh",(()=>{for(const e of this._tileStrategy.tiles)this._updateTile(e);this.requestUpdate();}))),this._overlayContainer=new M,this.container.addChild(this._overlayContainer),this._fetchQueue=new p$1({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new r$4({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate();}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear();}supportsSpatialReference(e){return !0}moveStart(){this.requestUpdate();}viewChange(){this.requestUpdate();}moveEnd(){this.requestUpdate();}update(e){this._tileStrategy.update(e);}async hitTest(e,t){const s=[],r$1=[e.x,e.y];for(const l of this.elements){const t=e$1(l.georeference)?.coords;r(t)&&s$2(t.rings,r$1)&&s.push({type:"media",element:l,layer:this.layer,mapPoint:e});}return s.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){}_acquireTile(e){const t=new R(e.clone());return this._updateTile(t),t}_updateTile(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[s,r]=e.setElements(t);this._acquireElements(e,s),this._releaseElements(e,r),this.requestUpdate();}),(e=>{g(e)||s.getLogger(this.declaredClass).error(e);})));}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._releaseElements(e,e.elements),this.requestUpdate();}async _queryElements(e,t$1){const s=this.layer.source;if(t(s))return [];this.view.featuresTilingScheme.getTileBounds(T,e,!0);const r=new M$2({xmin:T[0],ymin:T[1],xmax:T[2],ymax:T[3],spatialReference:this.view.spatialReference});return s.queryElements(r,t$1)}_acquireElements(e,t$1){const s=this.layer.source,i=this.view.spatialReference;if(!t(s))for(const o of t$1){r$5(this._elementReferences,o.uid,(()=>{const e=new a({element:o,spatialReference:i}),t=new _(e);return this._overlayContainer.addChild(t),this.elements.add(o),{tiles:new Set,projectedElement:e,overlay:t}})).tiles.add(e);}}_releaseElements(e,t){for(const s of t){const t=this._elementReferences.get(s.uid);t.tiles.delete(e),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s));}}};e([d()],w.prototype,"_fetchQueue",void 0),e([d()],w.prototype,"layer",void 0),e([d({readOnly:!0})],w.prototype,"elements",void 0),w=e([n("esri.views.2d.layers.MediaLayerView2D")],w);const T=u$1();class R{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0;}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const r of e)s.has(r)?s.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(s)]}}const S=w;

export { S as default };
//# sourceMappingURL=MediaLayerView2D.701880b8.js.map
